---
title: "Relatório de Ausências"
output: 
    html_document:
        css: style.css
    
---

```{r, include=FALSE, warning=FALSE, echo=FALSE}
library(RPostgreSQL)
library(tidyverse)
library(rgdal)
#devtools::install_github("analytics-ufcg/geopbutils")
source("../utils/get-functions.R")
library(GeoPBUtils)
library(DT)
library(formattable)
library(htmltools)

# Importa tabelas csv
tipos.das.obras <<- read.csv("../dados/tipos_obra.csv")
municipios.pb <- read.csv("../dados/municipios_pb.csv")
mapa_paraiba <<- readOGR("../dados/mapa-paraiba-ibge/Municipios.shp")

# Pega dados
drv <- DBI::dbDriver("PostgreSQL")

CONFIG_FILE_PATH = "../config/config.yml"

con1 <- DBI::dbConnect(drv,
                       host = config::get("host", file = CONFIG_FILE_PATH),
                       port = config::get("port", file = CONFIG_FILE_PATH),
                       user = config::get("user", file = CONFIG_FILE_PATH),
                       password = config::get("password", file = CONFIG_FILE_PATH),
                       dbname = config::get("dbname1", file = CONFIG_FILE_PATH)
)

con2 <- DBI::dbConnect(drv,
                       host = config::get("host", file = CONFIG_FILE_PATH),
                       port = config::get("port", file = CONFIG_FILE_PATH),
                       user = config::get("user", file = CONFIG_FILE_PATH),
                       password = config::get("password", file = CONFIG_FILE_PATH),
                       dbname = config::get("dbname2", file = CONFIG_FILE_PATH)
)

GeoPBUtils::get.data.faltantes(con1, con2, mapa_paraiba)

dbDisconnect(con1)
dbDisconnect(con2)

municipios <- data.frame(codigo_ibge = mapa_paraiba$GEOCODIG_M, 
                         lat = coordinates(mapa_paraiba)[,2], 
                         lon = coordinates(mapa_paraiba)[,1])

obras.2013 <- get.georreferencia.inputada(obra, localidade, tipos.das.obras, municipios,
                                          obra.georref.centroide.sumarizado, 2013) %>% 
    filter(codigo_ibge != 0)
```

### Seleciona colunas
Inicialmente selecionamos as colunas a serem utilizadas como método de avaliação das obras por município. Selecionaremos:

* Município
* Descrição
* Tipo da obra
* Valor
* Dimensão
* Foto - Junção do número de fotos de acompanhamentos e de medições
* Medição - Divididas entre total de medições e medições com informações válidas
* Georreferenciamento - Dividos em se tem georreferência ou se está fora do município, onde consideramos se a georreferencia está dentro do município apenas para os dados que não são KML
* Planilha Contratada
* ART - Número da ART fornecida pelo banco de dados
* Número do contrato 
* Data de ínicio e previsão do fim da obra
    
Como existem dados com data de início desde 1900, serão filtrados dados a partir de 2013 visto que possuem uma maior relevância para o contexto.

```{r, include=FALSE, warning=FALSE, echo=FALSE}
dados.georref <- acompanhamento %>%
    mutate(tem_valor_georref = valor_georeferenciamento != "0") %>%
    group_by(fk_obra) %>%
    summarise(tem_georreferenciamento = sum(tem_valor_georref) > 0)

obra.medicao.agrupada <- obra.medicao %>% 
    mutate(medicoes_ok = grepl(".xls", planilha_medicoes) | grepl(".pdf", planilha_medicoes)) %>% 
    group_by(fk_obra) %>% 
    summarise(total_de_medicoes = n(), 
              medicoes_ok = sum(medicoes_ok)) 

tb.dados.municipios <- obras.2013 %>% 
    select(id,
           nome.x,
           descricao_sucinta_obra, 
           nome.y, 
           valor_obra, 
           dimensao,
           dentro_municipio,
           planilha_contratada,
           numero_contrato, 
           data_inicio_obra,
           data_prevista_conclusao,
           data_conclusao_obra,
           data_recebimento_obra
           ) %>% 
    rename(municipio = nome.x, 
           tipo_obra = nome.y
           ) %>% 
    left_join(obra.medicao.agrupada, by = c("id" = "fk_obra")) %>% 
    mutate(medicoes_ok = ifelse(is.na(medicoes_ok), 0, medicoes_ok),
           total_de_medicoes = ifelse(is.na(total_de_medicoes), 0, total_de_medicoes)) %>% 
    left_join(obra.art, by = c("id" = "fk_obra")) %>% 
    left_join(obra.fotos, by = c("id" = "fk_obra")) %>% 
    mutate(num_fotos = ifelse(is.na(num_fotos), 0, num_fotos)) %>% 
    left_join(dados.georref, by = c("id" = "fk_obra")) %>% 
    mutate(tem_georreferenciamento = ifelse(is.na(tem_georreferenciamento), FALSE, tem_georreferenciamento),
           dentro_municipio = ifelse(is.na(dentro_municipio), FALSE, dentro_municipio)) %>% 
    select(-id)
```

Vamos definir o que são valores faltantes para cada coluna:

* descricao_sucinta_obra - deixaremos a critério dos auditores verificar, visto que é muito variável 
* tipo_obra - os que tiverem valores iguais a "OUTRAS"
* valor_obra - os que tiverem valores menores que R$ 1.000,00 e maiores que 100.000.000,00
* dimensao - os que tiverem dimensão igual a 0
* tem_georreferenciamento - os que não tem georreferenciamento, ou seja, o valor do georreferenciamento é igual a "0"
* dentro_municipio - os georreferenciamentos do tipo 1 e 3 que estão dentro do município
* planilha_contratada - um arquivo que não contenha ".xls", "xlsx" ou ".pdf"
* numero_contrato - numeros de contratos que são iguais a "0000"
* data_prevista_conclusao - valores faltantes
* data_conclusao_obra - valores faltantes
* data_recebimento_obra - valores faltantes de fato
* total_de_medicoes - obras com 0 medições
* medicoes_ok - pelo menos 80% dos arquivos de medição devem ter ".xls", "xlsx" ou ".pdf"
* numero_art - consideramos os valores que contém "PB201...", visto que utilizamos obras que iniciaram a partir de 2013
* num_fotos - obras com menos de uma foto por medição

```{r, include=FALSE, warning=FALSE, echo=FALSE}
obras.metricas.relevantes <- tb.dados.municipios %>% 
    mutate(
        tipo_obra_valida = tipo_obra != "OUTRAS",
        valor_obra_valida = valor_obra > 1000 & valor_obra < 100000000,
        dimensao_valida = dimensao > 0,
        planilha_contratada_valida = grepl(".xls", planilha_contratada) | grepl(".pdf", planilha_contratada),
        numero_contrato_valido = numero_contrato != "0000" & numero_contrato != "-",
        data_prevista_conclusao_valida = !is.na(data_prevista_conclusao),
        data_conclusao_obra_valida = !is.na(data_conclusao_obra),
        data_recebimento_obra_valida = !is.na(data_recebimento_obra),
        total_de_medicoes_valida = total_de_medicoes > 0,
        medicoes_ok_valida = ifelse(total_de_medicoes_valida, medicoes_ok/total_de_medicoes >= 0.8, FALSE),
        numero_art_valido = str_detect(numero_art, "(P|p)(B|b)201([:digit:]+)"),
        num_fotos_valida = ifelse(total_de_medicoes_valida, num_fotos >= total_de_medicoes, FALSE) 
    ) %>% 
    select(
        municipio,
        descricao_sucinta_obra,
        numero_art,
        valor_obra,
        dimensao,
        tipo_obra,
        tem_georreferenciamento,
        dentro_municipio,
        planilha_contratada,
        numero_contrato,
        total_de_medicoes,
        medicoes_ok,
        num_fotos,
        data_inicio_obra,
        data_prevista_conclusao,
        data_conclusao_obra,
        data_recebimento_obra,
        tipo_obra_valida,
        valor_obra_valida,
        dimensao_valida,
        planilha_contratada_valida,
        numero_contrato_valido,
        data_prevista_conclusao_valida,
        data_conclusao_obra_valida,
        data_recebimento_obra_valida,
        total_de_medicoes_valida,
        medicoes_ok_valida,
        numero_art_valido,
        num_fotos_valida
    )
```

Criaremos agora a visualização das informações faltantes das obras por municípios:

```{r, echo=FALSE, warning=FALSE}
options("scipen"=100, "digits"=4)

municipios <- obras.metricas.relevantes %>%
    distinct(municipio) %>%
    arrange(municipio) %>%
    pull(municipio)

# municipios <- c("João Pessoa", "Campina Grande")

show_plot <- function(mun, porc.dados.validos, plot_object) {
    div(style="margin:auto;text-align:center", 
        div(h3(paste0(mun, ": ", format(porc.dados.validos, decimal.mark=",", digits=2, nsmall=2), "% dos dados válidos"))), 
        div(class="table-obras", plot_object), 
        div(br())
        )
}

do.call(div, lapply(municipios, function(mun) { 
    obras.filt.mun <- obras.metricas.relevantes %>% 
            filter(municipio == mun) %>% 
            left_join(select(tipos.das.obras, nome, unidadeMedida), by = c("tipo_obra" = "nome")) %>% 
            mutate(unidadeMedida = ifelse(unidadeMedida == "-", "", as.character(unidadeMedida))) %>% 
            rowwise() %>% 
            mutate(
                dados_validos = sum(tipo_obra_valida, valor_obra_valida, dimensao_valida, dentro_municipio, 
                                      planilha_contratada_valida, numero_contrato_valido, !is.na(data_inicio_obra),
                                      data_prevista_conclusao_valida, data_conclusao_obra_valida, 
                                      data_recebimento_obra_valida, total_de_medicoes_valida, medicoes_ok_valida,
                                      num_fotos_valida, tem_georreferenciamento),
                valor_obra = paste("R$", format(valor_obra, big.mark=".", decimal.mark=",", digits=2, nsmall=2)),
                dimensao = paste(format(dimensao, big.mark=".", decimal.mark=",", digits=2, nsmall=2), unidadeMedida)
            ) %>% 
            select(-municipio, -unidadeMedida)
    
    porc.dados.validos <- sum(pull(obras.filt.mun, dados_validos)) / (14 * nrow(obras.filt.mun)) * 100
    
    show_plot(mun, porc.dados.validos, print(
        obras.filt.mun %>% 
            select(-dados_validos) %>% 
            formattable(list(
              numero_art = formatter(
                "span",
                class = ~ paste("celula", ifelse(numero_art_valido, "green", "red"))),
              numero_art_valido = FALSE,
              tipo_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(tipo_obra_valida, "green", "red"))),
              tipo_obra_valida = FALSE,
              valor_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(valor_obra_valida, "green", "red"))),
              valor_obra_valida = FALSE,
              dimensao = formatter(
                "span",
                class = ~ paste("celula", ifelse(dimensao_valida, "green", "red"))),
              dimensao_valida = FALSE,
              dentro_municipio = formatter(
                "span",
                class = ~ paste("celula", ifelse(dentro_municipio, "green", "red"))),
              planilha_contratada = formatter(
                "span",
                class = ~ paste("celula", ifelse(planilha_contratada_valida, "green", "red"))),
              planilha_contratada_valida = FALSE,
              numero_contrato = formatter(
                "span",
                class = ~ paste("celula", ifelse(numero_contrato_valido, "green", "red"))),
              numero_contrato_valido = FALSE,
              data_inicio_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(!is.na(data_inicio_obra), "green", "red"))),
              data_prevista_conclusao = formatter(
                "span",
                class = ~ paste("celula", ifelse(data_prevista_conclusao_valida, "green", "red"))),
              data_prevista_conclusao_valida = FALSE,
              data_conclusao_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(data_conclusao_obra_valida, "green", "red"))),
              data_conclusao_obra_valida = FALSE,
              data_recebimento_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(data_recebimento_obra_valida, "green", "red"))),
              data_recebimento_obra_valida = FALSE,
              total_de_medicoes = formatter(
                "span",
                class = ~ paste("celula", ifelse(total_de_medicoes_valida, "green", "red"))),
              total_de_medicoes_valida = FALSE,
              medicoes_ok = formatter(
                "span",
                class = ~ paste("celula", ifelse(medicoes_ok_valida, "green", "red"))),
              medicoes_ok_valida = FALSE,
              num_fotos = formatter(
                "span",
                class = ~ paste("celula", ifelse(num_fotos_valida, "green", "red"))),
              num_fotos_valida = FALSE,
              tem_georreferenciamento = formatter(
                "span",
                class = ~ paste("celula", ifelse(tem_georreferenciamento, "green", "red")))
          )) %>%
          as.datatable(
              options = list(
                autoWidth = TRUE,
                language = list(
                    info = "Mostrando obras de _START_ à _END_ de um total de _TOTAL_",
                    lengthMenu = "Mostrar _MENU_ itens",
                    paginate = list(previous = "Anterior", `next` = "Próxima", 
                                    first = "Primeira", last = "Última"),
                    search = "Pesquisar:"
                ))
          )
    ))
}))
```

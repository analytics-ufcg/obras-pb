---
title: "Relatório de Ausências"
output: 
    html_document:
        css: style.css
    
---

```{r, include=FALSE, warning=FALSE, echo=FALSE}
library(RPostgreSQL)
library(tidyverse)
library(rgdal)
#devtools::install_github("analytics-ufcg/geopbutils")
source("../utils/get-functions.R")
library(GeoPBUtils)
library(DT)
library(formattable)
library(htmltools)
library(bsselectR)

# Importa tabelas csv
tipos.das.obras <<- read.csv("../dados/tipos_obra.csv")
municipios.pb <- read.csv("../dados/municipios_pb.csv")
mapa_paraiba <<- readOGR("../dados/mapa-paraiba-ibge/Municipios.shp")

# Pega dados
drv <- DBI::dbDriver("PostgreSQL")

CONFIG_FILE_PATH = "../config/config.yml"

con1 <- DBI::dbConnect(drv,
                       host = config::get("host", file = CONFIG_FILE_PATH),
                       port = config::get("port", file = CONFIG_FILE_PATH),
                       user = config::get("user", file = CONFIG_FILE_PATH),
                       password = config::get("password", file = CONFIG_FILE_PATH),
                       dbname = config::get("dbname1", file = CONFIG_FILE_PATH)
)

con2 <- DBI::dbConnect(drv,
                       host = config::get("host", file = CONFIG_FILE_PATH),
                       port = config::get("port", file = CONFIG_FILE_PATH),
                       user = config::get("user", file = CONFIG_FILE_PATH),
                       password = config::get("password", file = CONFIG_FILE_PATH),
                       dbname = config::get("dbname2", file = CONFIG_FILE_PATH)
)

GeoPBUtils::get.data.faltantes(con1, con2, mapa_paraiba)

dbDisconnect(con1)
dbDisconnect(con2)

municipios <- data.frame(codigo_ibge = mapa_paraiba$GEOCODIG_M, 
                         lat = coordinates(mapa_paraiba)[,2], 
                         lon = coordinates(mapa_paraiba)[,1])

obras.2013 <- get.georreferencia.inputada(obra, localidade, tipos.das.obras, municipios,
                                          obra.georref.centroide.sumarizado, 2013) %>% 
    filter(codigo_ibge != 0)
```

### Seleciona colunas
Inicialmente selecionaremos as colunas a serem utilizadas como método de avaliação das obras por município, as quais estão descritas abaixo:

* Município
* Descrição
* Tipo da obra
* Valor
* Dimensão
* Foto - Junção do número de fotos de acompanhamentos e de medições
* Medição - Divididas entre total de medições e medições com informações válidas
* Georreferenciamento - Dividos em se tem georreferência ou se está fora do município, onde consideramos se a georreferencia está dentro do município apenas para os dados que não são KML
* Planilha Contratada
* ART - Número da ART fornecida pelo banco de dados
* Número do contrato 
* Data de ínicio e previsão do fim da obra
    
Como existem dados com data de início desde 1900, serão filtrados dados a partir de 2013 visto que possuem uma maior relevância para o contexto.

```{r, include=FALSE, warning=FALSE, echo=FALSE}
dados.georref <- acompanhamento %>%
    mutate(tem_valor_georref = valor_georeferenciamento != "0") %>%
    group_by(fk_obra) %>%
    summarise(tem_georreferenciamento_valido = sum(tem_valor_georref) > 0)

situacao.medicao.por.data <- obra.medicao %>% 
    group_by(fk_obra, data_final) %>% 
    summarise(situacao = ifelse(7 %in% situacao, 7,
                                ifelse(8 %in% situacao, 8,
                                       ifelse(1 %in% situacao, 1,
                                              ifelse(9 %in% situacao, 9,
                                                     ifelse(4 %in% situacao, 4,
                                                            ifelse(3 %in% situacao, 3,
                                                                   ifelse(2 %in% situacao, 2))))))))

obra.medicao.agrupada <- obra.medicao %>% 
    mutate(medicoes_ok = grepl(".xls", planilha_medicoes) | grepl(".pdf", planilha_medicoes)) %>% 
    group_by(fk_obra) %>% 
    summarise(total_de_medicoes = n(), 
              medicoes_ok = sum(medicoes_ok),
              data.ulti.medicao = max(data_final, na.rm = TRUE)) %>% 
    left_join(select(obra.medicao, -planilha_medicoes), by = c("fk_obra", "data.ulti.medicao" = "data_final"))

acomp.ulti.data <- acompanhamento %>% 
    filter(tipo != 3) %>% 
    group_by(fk_obra) %>% 
    summarise(data.ulti.acomp = max(data_cadastro, na.rm = TRUE))

acomp.inicial.final <- acompanhamento %>% 
    group_by(fk_obra) %>% 
    summarise(
        tem.acomp.inicial = sum(tipo == 1) > 0,
        tem.acomp.final = sum(tipo == 3) > 0
    ) %>% 
    left_join(acomp.ulti.data, by = "fk_obra")

tb.dados.municipios <- obras.2013 %>% 
    select(id,
           nome.x,
           descricao_sucinta_obra, 
           nome.y, 
           valor_obra, 
           dimensao,
           dentro_municipio,
           planilha_contratada,
           numero_contrato, 
           data_inicio_obra,
           data_prevista_conclusao,
           data_conclusao_obra,
           data_recebimento_obra,
           fk_jurisdicionado,
           numero_obra
           ) %>% 
    rename(municipio = nome.x, 
           tipo_obra = nome.y,
           dentro_municipio_valido = dentro_municipio
           ) %>% 
    left_join(obra.medicao.agrupada, by = c("id" = "fk_obra")) %>% 
    mutate(medicoes_ok = ifelse(is.na(medicoes_ok), 0, medicoes_ok),
           total_de_medicoes = ifelse(is.na(total_de_medicoes), 0, total_de_medicoes)) %>% 
    left_join(obra.art, by = c("id" = "fk_obra")) %>% 
    left_join(obra.fotos, by = "id") %>% 
    mutate(num_fotos_acompanhamento = ifelse(is.na(num_fotos_acompanhamento), 0, num_fotos_acompanhamento),
           num_fotos_medicao = ifelse(is.na(num_fotos_medicao), 0, num_fotos_medicao)) %>% 
    left_join(dados.georref, by = c("id" = "fk_obra")) %>% 
    mutate(tem_georreferenciamento_valido = ifelse(is.na(tem_georreferenciamento_valido), FALSE, tem_georreferenciamento_valido),
           tem_georreferenciamento = ifelse(tem_georreferenciamento_valido, "SIM", "NÃO"),
           dentro_municipio_valido = ifelse(is.na(dentro_municipio_valido), FALSE, dentro_municipio_valido),
           dentro_municipio = ifelse(dentro_municipio_valido, "SIM", "NÃO")) %>% 
    left_join(obra.proj.basico, by = c("id" = "fk_obra")) %>% 
    left_join(jurisdicionado_db2, by = c("fk_jurisdicionado" = "id")) %>% 
    left_join(acomp.inicial.final, by = c("id" = "fk_obra")) %>% 
    mutate(tem_acompanhamento_inicial_valido = !is.na(tem.acomp.inicial) & tem.acomp.inicial,
           tem_acompanhamento_final_valido = !is.na(tem.acomp.final) & tem.acomp.final) %>% 
    select(-id, -fk_jurisdicionado, -tem.acomp.inicial, -tem.acomp.final)
```

Para estimar a situação das obras, que constam em execução normal, utilizaremos os seguintes critérios:

* Com informações de concluída (deve satisfazer pelo menos um dos critérios):
    + Se existir data de recebimento 
    + Se a última medição consta em situação "Finalizada por Conclusão de Construção" 
    + Se a última medição consta em situação "Finalizada Administrativa ou Judicialmente"
    
* Com informações em andamento (deve satisfazer pelo menos um dos critérios):
    + Se a data da última medição não exceder 90 dias
    + Se a data do último acompanhamento não exceder 90 dias, contanto que o acompanhamento não seja final
    + Se a duração da obra não exceder 180 dias
    
* Desatualizada
    + Se não se encaixar nos critérios anteriores

* Com informações de não concluídas 
    + Se tiver como situação "Atrasada (Cronograma Atrasado)"
    + Se tiver como situação "Paralisada (sem Execução)"
    + Se tiver como situação "Inacabada (Não Concluída Após Término do Contrato)"
    + Se tiver como situação "Abandonada"

_As obras que constam em situação "Atrasada (Cronograma Atrasado)", "Paralisada (Sem Execução)", "Inacabada (Não Concluída Após Término do Contrato)" e "Abandonada" serão incluídas no grupo de obras paralisadas._

Para definir a situação da última medição, quando existe múltiplas medições na última data de medição da obra, utilizaremos a seguinte ordem de prioridade:

1. Finalizada por Conclusão de Construção
2. Finalizada Administrativa ou Judicialmente
3. Em Execução Normal (Dentro do Cronograma)
4. Abandonada
5. Inacabada (Não Concluída Após Término do Contrato)
6. Paralisada (Sem Execução)
7. Atrasada (Cronograma Atrasado)

```{r, echo=FALSE, warning=FALSE}
ultima.data <- "2017-12-15"


desc.situacoes <- data.frame(situacao = c(1,2,3,4,7,8,9), tipo.situacao = c("Em Execução Normal (Dentro do Cronograma)","Atrasada (Cronograma Atrasado)",
                                                          "Paralisada (Sem Execução)", "Inacabada (Não Concluída Após Término do Contrato)", 
                                                          "Finalizada por Conclusão de Construção", "Finalizada Administrativa ou Judicialmente",
                                                          "Abandonada"))

tb.dados.municipios <- tb.dados.municipios %>% 
    mutate(
        tempo.de.obra = difftime(lubridate::ymd(ultima.data), lubridate::ymd(data_inicio_obra),units="days"),
        tempo.data.prevista.acomp.final = difftime(lubridate::ymd(data.acomp.final), lubridate::ymd(data_prevista_conclusao),units="days"),
        tempo.data.prevista = difftime(lubridate::ymd(ultima.data), lubridate::ymd(data_prevista_conclusao),units="days"),
        tempo.ulti.acomp = difftime(lubridate::ymd(ultima.data), lubridate::ymd(data.ulti.acomp),units="days"),
        tempo.ulti.medicao = difftime(lubridate::ymd(ultima.data), lubridate::ymd(data.ulti.medicao),units="days"),
        acomp.menor.90.dias = !is.na(tempo.ulti.acomp) & tempo.ulti.acomp <= 90,
        medicao.menor.90.dias = !is.na(tempo.ulti.medicao) & tempo.ulti.medicao <= 90,
        situacao_estimada = ifelse(!is.na(situacao) & situacao %in% c(7, 8) | !is.na(data_recebimento_obra),
                          "CONCLUÍDA",
                          ifelse(!is.na(situacao) & situacao == 1 & (medicao.menor.90.dias | acomp.menor.90.dias | tempo.de.obra <= 180), 
                                 "EM ANDAMENTO", 
                                 "PARALISADA")
                          )
    ) %>% 
    select(-tempo.ulti.acomp, -tempo.ulti.medicao, -acomp.menor.90.dias, -medicao.menor.90.dias)
```

Vamos definir o que são valores faltantes para cada coluna, onde utilizaremos estes critérios no restante da análise:

* descricao_sucinta_obra - deixaremos a critério dos auditores verificar, visto que é muito variável 
* numero_art - ARTS que não seguirem o padrão: UF (PB) + 11 Dígitos Numéricos, caso o valor seja maior ou igual à R$30.000,00 e registradas a partir de 01/01/2015
* valor_obra - os que tiverem valores menores que R$ 10.000,00 e maiores ou iguais à 100.000.000,00
* dimensao - os que tiverem dimensão igual a 0 ou faltante
* tipo_obra - os que tiverem valores iguais a "OUTRAS" ou faltante
* tem_georreferenciamento - as que não tem georreferenciamento, ou seja, o valor do georreferenciamento é igual a “0”, caso a obra tenha mais de 90 dias e o valor seja maior ou igual à R$30.000,00 
* dentro_municipio - os georreferenciamentos do tipo 1 e 3 que estão dentro do município (podendo ser até 5 km da fronteira), caso a obra tenha mais de 90 dias e o valor seja maior ou igual à R$30.000,00
* planilha_contratada - um arquivo que não contenha “.xls”, “xlsx” ou “.csv”, caso o valor seja maior ou igual à R$30.000,00 
* numero_contrato - números de contratos que são iguais a “0000”, "-" ou faltante
* total_de_medicoes -  obras com 0 medições, caso a obra tenha mais de 90 dias e o valor seja maior ou igual à R$150.000,00
* medicoes_ok - menos de 80% dos arquivos de medição com “.xls”, “xlsx” ou “csv”, caso o valor seja maior ou igual à R$150.000,00
* num_fotos_medicao - menos de uma foto por medição, caso o valor seja maior ou igual à R$150.000,00
* num_fotos_acompanhamento - 0 fotos de acompanhamento, caso a obra tenha mais de 90 dias e o valor seja maior ou igual à R$30.000,00
* data_prevista_conclusao - valores faltantes
* data_conclusao_obra - valores faltantes, caso a situacao estimada da obra não seja "EM ANDAMENTO"
* data_recebimento_obra - valores faltantes, caso a situacao estimada da obra não seja "EM ANDAMENTO" ou os que tiverem recebimento anterior à conclusão
* projeto_basico - valores faltantes, caso o valor seja maior ou igual à R$30.000,00
* tem_acompanhamento_inicial - os que não tiverem acompanhamento inicial, caso a obra já tenha mais de 90 dias e o valor seja maior ou igual à R$30.000,00
* tem_acompanhamento_final - os que não tiverem acompanhamento final, caso já tenham passado mais de 90 dias da data prevista de conclusão e o valor seja maior ou igual à R$30.000,00.
* numero_obra - valores que não seguirem o padrão: 8 dígitos, sendo os quatro primeiros um identificador interno da obra pelo jurisdicionado e os quatro últimos o ano da obra, válido apenas para a esfera municipal

```{r, include=FALSE, warning=FALSE, echo=FALSE}
obras.metricas.relevantes <- tb.dados.municipios %>% 
    mutate(
        numero_art_opcional = valor_obra >= 10000 & valor_obra < 30000,
        numero_art_valido = str_detect(numero_art, paste0("(P|p)(B|b)\\s?(201[4-8]|1900)([:digit:]{7})")) | 
            numero_art_opcional | lubridate::year(data_inicio_obra) < 2015,
        valor_obra_valida = valor_obra >= 10000 & valor_obra < 100000000,
        dimensao_valida = dimensao > 0 & !is.na(dimensao),
        tipo_obra_valida = !is.na(tipo_obra) & tipo_obra != "OUTRAS",
        tem_georreferenciamento_opcional = valor_obra >= 10000 & valor_obra < 30000,
        tem_georreferenciamento_valido = tem_georreferenciamento_valido | tempo.de.obra <= 90 | tem_georreferenciamento_opcional,
        dentro_municipio_opcional = valor_obra >= 10000 & valor_obra < 30000,
        dentro_municipio_valido = dentro_municipio_valido | tempo.de.obra <= 90 | dentro_municipio_opcional,
        planilha_contratada_opcional = valor_obra >= 10000 & valor_obra < 30000,
        planilha_contratada_valida = str_detect(planilha_contratada, "([:print:]+)(.xls|.csv)") | planilha_contratada_opcional,
        numero_contrato_valido = numero_contrato != "0000" & numero_contrato != "-" & !is.na(numero_contrato),
        total_de_medicoes_opcional = valor_obra >= 10000 & valor_obra < 150000,
        total_de_medicoes_valida = total_de_medicoes > 0 | tempo.de.obra <= 90 | total_de_medicoes_opcional,
        medicoes_ok_opcional = valor_obra >= 10000 & valor_obra < 150000,
        medicoes_ok_valida = ifelse(total_de_medicoes > 0, medicoes_ok/total_de_medicoes >= 0.8, FALSE) | tempo.de.obra <= 90 | 
            medicoes_ok_opcional,
        num_fotos_medicao_opcional = valor_obra >= 10000 & valor_obra < 150000,
        num_fotos_medicao_valida = num_fotos_medicao >= total_de_medicoes | num_fotos_medicao_opcional,
        num_fotos_acompanhamento_opcional = valor_obra >= 10000 & valor_obra < 30000,
        num_fotos_acompanhamento_valida = num_fotos_acompanhamento > 0 | num_fotos_acompanhamento_opcional | tempo.de.obra <= 90,
        data_inicio_obra_valida = !is.na(data_inicio_obra),
        data_prevista_conclusao_valida = !is.na(data_prevista_conclusao),
        data_conclusao_obra_valida = !is.na(data_conclusao_obra) | situacao_estimada == "EM ANDAMENTO",
        data_recebimento_obra_valida = (!is.na(data_recebimento_obra) & (!is.na(data_conclusao_obra) & data_recebimento_obra >= data_conclusao_obra)) |
            situacao_estimada == "EM ANDAMENTO",
        projeto_basico_opcional = valor_obra >= 10000 & valor_obra < 30000,
        projeto_basico_valido = !is.na(projeto_basico) | projeto_basico_opcional,
        tem_acompanhamentos_opcional = valor_obra >= 10000 & valor_obra < 30000,
        tem_acompanhamento_inicial_valido = tem_acompanhamento_inicial_valido | tempo.de.obra <= 90 | tem_acompanhamentos_opcional,
        tem_acompanhamento_final_valido = tem_acompanhamentos_opcional | (!is.na(tempo.data.prevista) & tempo.data.prevista <= 90) |
            (tem_acompanhamento_final_valido & 
            !is.na(tempo.data.prevista.acomp.final) & 
            tempo.data.prevista.acomp.final <= 90),
        numero_obra_valido = str_detect(numero_obra, paste0("^([:digit:]{4})", lubridate::year(data_inicio_obra), "$")) | esfera != 1,
        tem_acompanhamento_final = ifelse(tem_acompanhamento_final_valido, "SIM", "NÃO"),
        tem_acompanhamento_inicial = ifelse(tem_acompanhamento_final_valido, "SIM", "NÃO")
    ) %>% 
    select(
        municipio,
        descricao_sucinta_obra,
        numero_art,
        valor_obra,
        dimensao,
        tipo_obra,
        tem_georreferenciamento,
        dentro_municipio,
        planilha_contratada,
        numero_contrato,
        total_de_medicoes,
        medicoes_ok,
        num_fotos_medicao,
        num_fotos_acompanhamento,
        data_inicio_obra,
        data_prevista_conclusao,
        data_conclusao_obra,
        data_recebimento_obra,
        projeto_basico,
        numero_obra,
        situacao_estimada,
        numero_art_valido,
        valor_obra_valida,
        dimensao_valida,
        tipo_obra_valida,
        tem_georreferenciamento_valido,
        dentro_municipio_valido,
        planilha_contratada_valida,
        numero_contrato_valido,
        total_de_medicoes_valida,
        medicoes_ok_valida,
        num_fotos_medicao_valida,
        num_fotos_acompanhamento_valida,
        data_inicio_obra_valida,
        data_prevista_conclusao_valida,
        data_conclusao_obra_valida,
        data_recebimento_obra_valida,
        projeto_basico_valido,
        numero_obra_valido,
        numero_art_opcional,
        tem_georreferenciamento_opcional,
        dentro_municipio_opcional,
        planilha_contratada_opcional,
        total_de_medicoes_opcional,
        medicoes_ok_opcional,
        num_fotos_medicao_opcional,
        num_fotos_acompanhamento_opcional,
        projeto_basico_opcional,
        tem_acompanhamento_final,
        tem_acompanhamento_inicial,
        tem_acompanhamentos_opcional,
        tem_acompanhamento_final_valido,
        tem_acompanhamento_inicial_valido
    )
```

Vejamos um panorama das colunas mais preenchidas:

```{r, echo=FALSE, warning=FALSE}
porc.metricas.validas <- obras.metricas.relevantes %>%  
    mutate(grupo = 1) %>% 
    group_by(grupo) %>% 
    summarise(
              numero_art = sum(numero_art_valido == TRUE & numero_art_opcional == FALSE) / sum(numero_art_opcional == FALSE),
              valor_obra = sum(valor_obra_valida) / n(), 
              dimensao = sum(dimensao_valida) / n(), 
              tipo_obra = sum(tipo_obra_valida) / n(),
              tem_georreferenciamento = sum(tem_georreferenciamento_valido == TRUE & tem_georreferenciamento_opcional == FALSE) / sum(tem_georreferenciamento_opcional == FALSE), 
              dentro_municipio = sum(dentro_municipio_valido & !dentro_municipio_opcional) / sum(!dentro_municipio_opcional), 
              planilha_contratada = sum(planilha_contratada_valida == TRUE & planilha_contratada_opcional == FALSE) / sum(planilha_contratada_opcional == FALSE), 
              numero_contrato = sum(numero_contrato_valido) / n(),
              total_de_medicoes = sum(total_de_medicoes_valida == TRUE & total_de_medicoes_opcional == FALSE) / sum(total_de_medicoes_opcional == FALSE), 
              medicoes_ok = sum(medicoes_ok_valida == TRUE & medicoes_ok_opcional == FALSE) / sum(!medicoes_ok_opcional),
              num_fotos_medicao = sum(num_fotos_medicao_valida == TRUE & num_fotos_medicao_opcional == FALSE) / sum(num_fotos_medicao_opcional == FALSE), 
              num_fotos_acompanhamento = sum(num_fotos_acompanhamento_valida == TRUE & num_fotos_acompanhamento_opcional == FALSE) / sum(num_fotos_acompanhamento_opcional == FALSE), 
              data_inicio_obra = sum(data_inicio_obra_valida) / n(),
              data_prevista_conclusao = sum(data_prevista_conclusao_valida) / n(), 
              data_conclusao_obra = sum(data_conclusao_obra_valida) / n(), 
              data_recebimento_obra = sum(data_recebimento_obra_valida) / n(), 
              projeto_basico = sum(projeto_basico_valido == TRUE & projeto_basico_opcional == FALSE) / sum(projeto_basico_opcional == FALSE), 
              tem_acompanhamento_inicial = sum(tem_acompanhamento_inicial_valido == TRUE & tem_acompanhamentos_opcional == FALSE) / sum(tem_acompanhamentos_opcional == FALSE), 
              tem_acompanhamento_final = sum(tem_acompanhamento_final_valido == TRUE & tem_acompanhamentos_opcional == FALSE) / sum(tem_acompanhamentos_opcional == FALSE),
              numero_obra = sum(num_fotos_acompanhamento_valida) / n() 
              ) %>% 
    select(-grupo) %>% 
    t() %>% 
    as.data.frame()

porc.metricas.validas$criterios <- rownames(porc.metricas.validas)

porc.metricas.validas <- porc.metricas.validas %>%
    rename(porcentagem.criterios.validos = V1) 
    

porc.metricas.validas %>% 
    ggplot(aes(x = reorder(criterios, porcentagem.criterios.validos), y = porcentagem.criterios.validos)) +
    geom_bar(stat = "identity") +
    labs(x = "Critérios", y = "Porcentagem de critérios válidos", title = "Porcentagem dos critérios válidos") +
    coord_flip() +
    scale_y_continuous(label = percent) 
    
```


Vejamos agora um panorama geral dos municípios:

```{r, echo=FALSE, warning=FALSE}
obras.metricas.relevantes <- obras.metricas.relevantes %>% 
    rowwise() %>% 
    mutate(
        criterios_validos = sum(numero_art_valido & !numero_art_opcional, valor_obra_valida, dimensao_valida, 
                            tipo_obra_valida, tem_georreferenciamento_valido & !tem_georreferenciamento_opcional,
                            dentro_municipio_valido & !dentro_municipio_opcional, 
                            planilha_contratada_valida & !planilha_contratada_opcional, numero_contrato_valido,
                            total_de_medicoes_valida & !total_de_medicoes_opcional, 
                            medicoes_ok_valida & !medicoes_ok_opcional, 
                            num_fotos_medicao_valida & !num_fotos_medicao_opcional, 
                            num_fotos_acompanhamento_valida & !num_fotos_acompanhamento_opcional,
                            data_inicio_obra_valida, data_prevista_conclusao_valida, 
                            data_conclusao_obra_valida, data_recebimento_obra_valida, 
                            projeto_basico_valido & !projeto_basico_opcional, 
                            tem_acompanhamento_inicial_valido & !tem_acompanhamentos_opcional,
                            tem_acompanhamento_final_valido & !tem_acompanhamentos_opcional,
                            numero_obra_valido),
        criterios_obrigatorios = nrow(porc.metricas.validas) - sum(numero_art_opcional, tem_georreferenciamento_opcional,
                            dentro_municipio_opcional, planilha_contratada_opcional, total_de_medicoes_opcional, 
                            medicoes_ok_opcional, num_fotos_medicao_opcional, num_fotos_acompanhamento_opcional,
                            projeto_basico_opcional, tem_acompanhamentos_opcional),
        porc_criterios_validos = criterios_validos / criterios_obrigatorios
        )

panorama.municipios <- obras.metricas.relevantes %>% 
    group_by(municipio) %>% 
    summarise(porc.criterios.validos = sum(porc_criterios_validos) / n())

panorama.municipios %>% 
    ggplot(aes(x = "municipios", y = porc.criterios.validos)) + 
    scale_y_continuous(labels = percent) +
    geom_boxplot() + 
    labs(x = "Municípios", y = "Porcentagem de critérios válidos", title = "Porcentagem de critérios válidos por município")
```

A mediana de critérios válidos por município é cerca de 45% e os mesmos tem pequena variação, visto que 50% dos municípios preenchem entre cerca de 42% e 49% dos critérios. Apesar da baixa variação, existem municípios que se destacaram positivamente, tendo cerca de 61% dos critérios preenchidos.

Vejamos os municípios mais detalhadamente:

```{r, echo=FALSE, warning=FALSE, fig.height=30}
panorama.municipios %>% 
    ggplot(aes(x = reorder(municipio, porc.criterios.validos), y = porc.criterios.validos, label = paste0(format(porc.criterios.validos * 100, decimal.mark=",", digits=2, nsmall=2), "%"))) +
    geom_bar(stat = "identity") +
    geom_text(position = position_stack(vjust = 0.5), colour = "white") +
    labs(x = "Municípios", y = "Porcentagem de critérios válidos", title = "Porcentagem de critérios válidos por município") +
    coord_flip() +
    scale_y_continuous(label = percent)
```

Vemos que os municípios que mais se destacaram foram Pilões, os quais tem pouco mais de 60% dos critérios preenchidos corretamente.

Criaremos agora a visualização das informações faltantes das obras por municípios, onde os critérios inválidos são representados por laranja, os válidos por verde e os opcionais por cinza:

```{r, echo=FALSE, warning=FALSE}
options("scipen"=100, "digits"=4)

municipios <- obras.metricas.relevantes %>%
    distinct(municipio) %>%
    arrange(municipio) %>%
    pull(municipio)

#municipios <- c("João Pessoa")

div(bsselect(municipios, type = "text"))

tags$script('
    $(document).ready(function(){
            $(".bsselect").css("display", "none")
            
            var changeTable = function(){
                var selected = $(".selectpicker").val()
                var regex = new RegExp("^" + selected + ":");
        		$(".table-municipio h3").filter(function () {
                        return !regex.test($(this).text()); 
                    }).parent().parent().css("display", "none")
        		$(".table-municipio h3").filter(function () {
                        return regex.test($(this).text()); 
                    }).parent().parent().css("display", "")
                $(".bsselect").parent().find("p").text("")
            }
            
    		$(".selectpicker").change(changeTable)
            $(".bsselect").parent().find("p").text("")
            /*changeTable()*/
    })
')

show_plot <- function(mun, porc.criterios.validos, plot_object) {
    div(style="margin:auto;text-align:center",
        div(class="table-municipio",
            h3(paste0(mun, ": ", format(porc.criterios.validos, decimal.mark=",", digits=2, nsmall=2), "% dos critérios válidos"))),
        div(class="table-obras", plot_object),
        div(br())
        )
}

do.call(div, lapply(municipios, function(mun) {
    obras.filt.mun <- obras.metricas.relevantes %>%
            filter(municipio == mun) %>%
            left_join(select(tipos.das.obras, nome, unidadeMedida), by = c("tipo_obra" = "nome")) %>%
            mutate(unidadeMedida = ifelse(unidadeMedida == "-", "", as.character(unidadeMedida))) %>%
            rowwise() %>%
            mutate(
                valor_obra = paste("R$", format(valor_obra, big.mark=".", decimal.mark=",", digits=2, nsmall=2)),
                dimensao = paste(format(dimensao, big.mark=".", decimal.mark=",", digits=2, nsmall=2), unidadeMedida),
                projeto_basico = ifelse(is.na(projeto_basico), "", projeto_basico)
            ) %>%
            select(-municipio, -unidadeMedida, -criterios_obrigatorios, -porc_criterios_validos) %>%
            arrange(-criterios_validos, -numero_art_valido, -valor_obra_valida, -dimensao_valida, -tipo_obra_valida,
                  -tem_georreferenciamento_valido, -dentro_municipio_valido, -planilha_contratada_valida, -numero_contrato_valido,
                  -total_de_medicoes_valida, -medicoes_ok_valida, -num_fotos_medicao_valida, -num_fotos_acompanhamento_valida,
                  -data_inicio_obra_valida,  -data_prevista_conclusao_valida, -data_conclusao_obra_valida, 
                  -data_recebimento_obra_valida, -projeto_basico_valido, -tem_acompanhamento_inicial_valido, -tem_acompanhamento_final_valido, -numero_obra_valido)

    porc.criterios.validos <- panorama.municipios %>% 
        filter(municipio == mun) %>% 
        pull(porc.criterios.validos) * 100

    show_plot(mun, porc.criterios.validos, print(
        obras.filt.mun %>%
            formattable(list(
              numero_art = formatter(
                "span",
                class = ~ paste("celula", ifelse(numero_art_opcional, "gray", ifelse(numero_art_valido, "green", "red")))),
              numero_art_valido = FALSE,
              numero_art_opcional = FALSE,
              valor_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(valor_obra_valida, "green", "red"))),
              valor_obra_valida = FALSE,
              dimensao = formatter(
                "span",
                class = ~ paste("celula", ifelse(dimensao_valida, "green", "red"))),
              dimensao_valida = FALSE,
              tipo_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(tipo_obra_valida, "green", "red"))),
              tipo_obra_valida = FALSE,
              tem_georreferenciamento = formatter(
                "span",
                class = ~ paste("celula", ifelse(tem_georreferenciamento_opcional, "gray", ifelse(tem_georreferenciamento_valido, "green", "red")))),
              tem_georreferenciamento_valido = FALSE,
              tem_georreferenciamento_opcional = FALSE,
              dentro_municipio = formatter(
                "span",
                class = ~ paste("celula", ifelse(dentro_municipio_opcional, "gray", ifelse(dentro_municipio_valido, "green", "red")))),
              dentro_municipio_valido = FALSE,
              dentro_municipio_opcional = FALSE,
              planilha_contratada = formatter(
                "span",
                class = ~ paste("celula", ifelse(planilha_contratada_opcional, "gray", ifelse(planilha_contratada_valida, "green", "red")))),
              planilha_contratada_valida = FALSE,
              planilha_contratada_opcional = FALSE,
              numero_contrato = formatter(
                "span",
                class = ~ paste("celula", ifelse(numero_contrato_valido, "green", "red"))),
              numero_contrato_valido = FALSE,
              total_de_medicoes = formatter(
                "span",
                class = ~ paste("celula", ifelse(total_de_medicoes_opcional, "gray", ifelse(total_de_medicoes_valida, "green", "red")))),
              total_de_medicoes_valida = FALSE,
              total_de_medicoes_opcional = FALSE,
              medicoes_ok = formatter(
                "span",
                class = ~ paste("celula", ifelse(medicoes_ok_opcional, "gray", ifelse(medicoes_ok_valida, "green", "red")))),
              medicoes_ok_valida = FALSE,
              medicoes_ok_opcional = FALSE,
              num_fotos_medicao = formatter(
                "span",
                class = ~ paste("celula", ifelse(num_fotos_medicao_opcional, "gray", ifelse(num_fotos_medicao_valida, "green", "red")))),
              num_fotos_medicao_valida = FALSE,
              num_fotos_medicao_opcional = FALSE,
              num_fotos_acompanhamento = formatter(
                "span",
                class = ~ paste("celula", ifelse(num_fotos_acompanhamento_opcional, "gray", ifelse(num_fotos_acompanhamento_valida, "green", "red")))),
              num_fotos_acompanhamento_valida = FALSE,
              num_fotos_acompanhamento_opcional = FALSE,
              data_inicio_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(data_inicio_obra_valida, "green", "red"))),
              data_inicio_obra_valida = FALSE,
              data_prevista_conclusao = formatter(
                "span",
                class = ~ paste("celula", ifelse(data_prevista_conclusao_valida, "green", "red"))),
              data_prevista_conclusao_valida = FALSE,
              data_conclusao_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(data_conclusao_obra_valida, "green", "red"))),
              data_conclusao_obra_valida = FALSE,
              data_recebimento_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(data_recebimento_obra_valida, "green", "red"))),
              data_recebimento_obra_valida = FALSE,
              projeto_basico = formatter(
                "span",
                class = ~ paste("celula", ifelse(projeto_basico_opcional, "gray", ifelse(projeto_basico_valido, "green", "red")))),
              projeto_basico_valido = FALSE,
              projeto_basico_opcional = FALSE,
              tem_acompanhamento_inicial = formatter(
                "span",
                class = ~ paste("celula", ifelse(tem_acompanhamentos_opcional, "gray", ifelse(tem_acompanhamento_inicial_valido, "green", "red")))),
              tem_acompanhamento_inicial_valido = FALSE,
              tem_acompanhamentos_opcional = FALSE,
              tem_acompanhamento_final = formatter(
                "span",
                class = ~ paste("celula", ifelse(tem_acompanhamentos_opcional, "gray", ifelse(tem_acompanhamento_final_valido, "green", "red")))),
              tem_acompanhamento_final_valido = FALSE,
              tem_acompanhamentos_opcional = FALSE,
              numero_obra = formatter(
                "span",
                class = ~ paste("celula", ifelse(numero_obra_valido, "green", "red"))),
              numero_obra_valido = FALSE,
              situacao_estimada = formatter(
                "span",
                class = ~ paste("celula", ifelse(situacao_estimada != "PARALISADA", "green", "red")))
          )) %>%
          as.datatable(
              options = list(
                autoWidth = TRUE,
                language = list(
                    info = "Mostrando obras de _START_ à _END_ de um total de _TOTAL_",
                    lengthMenu = "Mostrar _MENU_ itens",
                    paginate = list(previous = "Anterior", `next` = "Próxima",
                                    first = "Primeira", last = "Última"),
                    search = "Pesquisar:"
                ))
          )
    ))
}))
```

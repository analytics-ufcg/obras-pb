---
title: "Dados disponíveis por época"
output: 
    html_document:
        toc: true
        toc_float: true
        fig_width: 10
        fig_heigth: 8 
---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(RPostgreSQL)
library(knitr)
```


##Introdução

Os dados utilizados nessa análise são provenientes do banco de dados do TCE/PB, mais específicamente as bases de dados cabobranco e vigia, as quais são utilizadas na aplicação GEO Obras.

O intuito deste ralatório é verificar a disponibilidade dos dados temporalmente, visto que algumas colunas só se tornaram obrigatórias depois de algum tempo.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
drv <- DBI::dbDriver("PostgreSQL")

con1 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname1")
)

obra <- dbGetQuery(con1, "select * from t_obra")        
acompanhamento <- dbGetQuery(con1, "select * from t_acompanhamento")
complexo <- dbGetQuery(con1, "select * from t_complexo")
evolucao <- dbGetQuery(con1, "select * from t_evolucao")

con2 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname2")
)

jurisdicionado_db2 <- dbGetQuery(con2, "select * from t_jurisdicionado")

tipos.das.obras <- read.csv("tipos_obra.csv")
```

Utilizaremos a tabela de evolucao e utilizaremos a data de início da obra para fazera análise temporal.

```{r, echo=FALSE}
evolucao %>% 
    select(id, data_inicio_obra, data_prevista_conclusao, data_cadastro, fk_obra) %>% 
    head() %>% 
    kable()
```

## Análise da geolocalização temporalmente

Vejamos a existência dos dados georeferenciados temporalmente, onde a existência dos mesmos será indicada caso a geolocalização for do tipo 1 ou 3, visto que são os tipos cujos valores de geolocalização estão presentes na própria tabela, sendo um par de latitude e longitude, ou uma lista de pares. Não consideraremos os do tipo 2, que é uma referência para um arquivo .kml nem o tipo 0 que de fato é o valor inexistente.

```{r, echo=FALSE}
geolocalizacao <- acompanhamento %>% 
    group_by(fk_obra) %>% 
    summarise(
        tipo_georeferenciamento = ifelse(3 %in% tipo_georeferenciamento, 
                                             3,
                                             ifelse(1 %in% tipo_georeferenciamento, 
                                                    1,
                                                    ifelse(2 %in% tipo_georeferenciamento,
                                                           2,
                                                           0
                                                           )
                                                    )
                                             )
    ) %>% 
    left_join(evolucao, by = "fk_obra") %>% 
    select(fk_obra, tipo_georeferenciamento, data_inicio_obra) %>% 
    mutate(ano = lubridate::year(data_inicio_obra))

geolocalizacao.temporal <- geolocalizacao %>% 
    group_by(ano) %>% 
    summarise(
        total = n(),
        obras.geolocalizadas = sum(tipo_georeferenciamento == 1, tipo_georeferenciamento == 3),
        porcentagem.localizacao.disponivel = obras.geolocalizadas / total
        )

geolocalizacao.temporal %>%     
    filter(ano > 1900) %>% 
    ggplot(aes(x = ano, y = porcentagem.localizacao.disponivel)) +
        geom_line() +
        scale_y_continuous(labels=scales::percent) +
        labs(y = "porcentagem das obras georeferenciadas disponíveis", 
             title = "Porcentagem das obras georeferenciadas disponíveis ao longo do tempo",
             subtitle = "Considerando obras depois de 1900")
```

Analisando os dados de georeferenciamentos disponíveis, verificamos que existem alguns dados a partir de 2010, mas apenas no ano de 2017 existe um percentual razoável de dados geolocalizados, visto que chega a pouco mais de `r (geolocalizacao.temporal %>% select(porcentagem.localizacao.disponivel) %>% max() * 100) %>% format(digits=2, nsmall=2)`%.

Vejamos em números absoutos:

```{r, echo=FALSE}
geolocalizacao.temporal %>%     
    filter(ano > 1900) %>% 
    ggplot(aes(x = ano, y = obras.geolocalizadas)) +
        geom_line() +
        labs(y = "quantidade de obras georeferenciadas", 
             title = "Quantidade de obras georeferenciadas ao longo do tempo",
             subtitle = "Considerando obras depois de 1900")
```

Podemos perceber que o número absoluto de obras geolocalizadas começa a crescer moderadamente a partir de 2010, mas tem uma ascensão mais forte a partir de 2015, chegando em `r geolocalizacao.temporal %>% select(obras.geolocalizadas) %>% max()` obras em 2017.

No total, existem `r geolocalizacao.temporal %>% select(obras.geolocalizadas) %>% sum()` geolocalizadas.

## Análise do valor das obras temporalmente

### Valor da obra disponível

Vejamos primeiramente os dados disponíveis por época:

```{r, echo=FALSE}
obra.data <- obra %>% 
    left_join(evolucao, by = c("id" = "fk_obra")) %>% 
    select(id, data_inicio_obra, valor_obra, descricao_sucinta_obra) %>% 
    mutate(ano = lubridate::year(data_inicio_obra))

obra.data %>% 
    filter(valor_obra > 0, valor_obra <= 100) %>% 
    arrange(valor_obra) %>% 
    head() %>% 
    kable()

obra.data %>% 
    filter(valor_obra > 0, valor_obra <= 100) %>% 
    arrange(valor_obra) %>% 
    tail() %>% 
    kable()
```

É possível ver que existem várias obras com valores maior que zero, mas mesmo assim não condizem com o valor real de uma obra. Com isso, vamos considerar como valor válido obras com mais de 100 reais.

```{r, echo=FALSE}
obra.temporal <- obra.data %>% 
    group_by(ano) %>% 
    summarise(
        total = n(),
        quantidade.valor.disponivel = sum(valor_obra > 100),
        proporcao.valor.disponivel = quantidade.valor.disponivel / total
        )
```

Vejamos a proporção de obras com valores válidos:

```{r, echo=FALSE}
obra.temporal %>% 
    filter(ano > 1900) %>% 
    ggplot(aes(x = ano, y = proporcao.valor.disponivel)) +
        geom_line() +
        scale_y_continuous(labels = scales::percent) +
        labs(y = "proporção de obras com valor disponível", 
             title = "Proporção de obras com valor disponível ao longo do tempo",
             subtitle = "Considerando obras depois de 1900")
```

Vemos que os dados do valor da obra começaram a ser colocados apenas em 2013 e quase todas obras tem valor a partir de 2015.

Vejamos em números absolutos:

```{r, echo=FALSE}
obra.temporal %>% 
    filter(ano > 1900) %>% 
    mutate(quantidade.valor.indisponivel = total - quantidade.valor.disponivel) %>% 
    select(-proporcao.valor.disponivel, -total) %>% 
    rename(
        disponivel = quantidade.valor.disponivel,
        indisponivel = quantidade.valor.indisponivel
    ) %>% 
    gather(tipo, quantidade, -ano, na.rm = TRUE) %>% 
    ggplot(aes(x = ano, y = quantidade, color = tipo)) +
        geom_line() +
        labs(y = "quantidade por disponibilidade", 
             title = "Quantidade de obras com valor disponível ou indisponível ao longo do tempo",
             subtitle = "Considerando obras depois de 1900")
```

Vemos que grande parte das obras que tem valor foram iniciadas entre 2013 e 2015, enquanto as obras sem valor disponível foran iniciadas antes de 2013, ou seja, o campo valor da obra começou a ser preenchido a partir de 2013.

### Análise do valor das obras temporalmente

Vejamos se os valores das obras vem aumentando desde 2013, ano que estas começaram a ser preenchidas com vigor:

```{r, echo=FALSE}
obra.data.filtrado <- obra.data %>% 
    filter(ano >= 2013, valor_obra > 100)

obra.data.filtrado %>% 
    group_by(ano) %>% 
    summarise(
        media.valor.obra = mean(valor_obra),
        mediana.valor.obra = median(valor_obra)
    ) %>% 
    gather(medida, valor, -ano) %>% 
    ggplot(aes(x = ano, y = valor, color = medida)) +
        geom_line() +
        labs(title = "Valor das obras ao longo do tempo",
             subtitle = "Considerando obras a partir de 2013")
```

Vemos que a mediana dos valores fica um pouco acima dos 100 mil reais, mas existe alguns outliers que elevam a média consideravelmente, criando uma grande diferença entre a média e a mediana.

Vejamos a dispersão do valor das obras ao longo do tempo:

```{r, echo=FALSE}
obra.data.filtrado %>% 
    filter(valor_obra < 1000000000) %>% 
    ggplot(aes(x = ano, y = valor_obra, group = ano)) +
        geom_boxplot() +
        scale_y_continuous(labels = scales::comma) +
        labs(y = "valor da obra", 
             title = "Valor das obras agrupados por ano ao longo do tempo",
             subtitle = "Considerando obras a partir de 2013")
```

Como comentado anteriormente, os valores das obras são bem concentrados, mas existem alguns outliers que elevam a média.

## Dimensão das obras temporalmente

### Dimensão da obra disponível

Vejamos primeiramente qual a medida de dimensão utilizada.

```{r, echo=FALSE}
obra.dimensao.data <- obra %>% 
    left_join(evolucao, by = c("id" = "fk_obra")) %>% 
    select(id, data_inicio_obra, dimensao, descricao_sucinta_obra) %>% 
    mutate(ano = lubridate::year(data_inicio_obra))

obra.dimensao.data %>% 
    filter(id %in% c(53, 28316, 28482)) %>% 
    kable()
```

Podemos ver primeiramente que a dimensão de algumas obras estão representadas em medidas diferentes, onde umas representam a dimensão em metros, outras representam em quilômetros, enquando outras representam em metros quadrados, o que torna difícil indicar quais dimensões com valor maior que zero são inválidas. Com isso consideraremos dimensões disponívels apenas as que tiverem valor maior que zero.

Vejamos a proporção de dados de dimensão disponíveis temporalmente:

```{r, echo=FALSE}
obra.dimensao.temporal <- obra.dimensao.data %>% 
    filter(ano > 1900) %>% 
    group_by(ano) %>% 
    summarise(
        total = n(),
        dimensoes.validas = sum(dimensao > 0),
        prop.dimensoes.validas = dimensoes.validas / total
        )

obra.dimensao.temporal %>% 
    ggplot(aes(x = ano, y = prop.dimensoes.validas)) +
        geom_line() +
        scale_y_continuous(labels = scales::percent) +
        labs(y = "proporção das dimensões disponíveis",
             title = "Proporção de dimensões das obras disponíveis ao longo do tempo",
             subtitle = "Considerando obras depois de 1900")
```

Vemos que os dados de dimensões começaram a ser implantados em 2015, mas só atingiram uma proporção considerável de dimensões válidas em 2017.

Vejamos em valores absolutos:

```{r, echo=FALSE}
obra.dimensao.temporal %>% 
    ggplot(aes(x = ano, y = dimensoes.validas)) +
        geom_line() +
        labs(y = "quantidade de dimensões válidas",
             title = "Quantidade de dimensões das obras válidas ao longo do tempo",
             subtitle = "Considerando obras depois de 1900")
```

Os valores absolutos seguem a mesma tendência dos proporcionais. No total temos `r obra.dimensao.temporal %>% select(dimensoes.validas) %>% sum()` obras com dimensões válidas.

### Dimensão da obra temporalmente

Vejamos quanto o valor das dimensões válidas variam no decorrer do tempo.

```{r, echo=FALSE}
obra.dimensao.data %>% 
    filter(dimensao > 0) %>% 
    group_by(ano) %>% 
    summarise(
        media.dimensao = mean(dimensao),
        median.dimensao = median(dimensao)
    ) %>% gather(medida, valor, -ano) %>% 
    ggplot(aes(x = ano, y = valor, color = medida)) +
        geom_line() +
        labs(title = "Dimensão das obras ao longo do tempo",
             subtitle = "Considerando obras com dimensão maior que zero")
```

Vemos que a mediana se mantém quase constante ao longo do tempo, tendo valor perto dos 400, enquanto a média varia bastante, o que indica que existem outliers nas dimensões das obras, como podemos ver a seguir:

```{r, echo=FALSE}
obra.dimensao.data %>% 
    filter(dimensao > 0) %>% 
    ggplot(aes(x = ano, y = dimensao, group = ano)) +
        geom_boxplot() +
        scale_y_continuous(labels = scales::comma) +
        labs(title = "Dimensão das obras agrupada por ano ao longo do tempo",
             subtitle = "Considerando obras com dimensão maior que zero")
```

## Tipo da obra temporalmente

### Disponibilidade de dados

Vejamos os tipos da obra disponíveis

```{r, echo=FALSE, warning=FALSE}
tipo.obra <- obra %>% 
    left_join(evolucao, by = c("id" = "fk_obra")) %>% 
    left_join(tipos.das.obras, by = c("fk_tipo_obra" = "id")) %>% 
    select(id, data_inicio_obra, fk_tipo_obra, descricao_sucinta_obra, nome) %>% 
    mutate(ano = lubridate::year(data_inicio_obra)) %>% 
    rename(tipo_da_obra = nome)

tipo.obra %>% 
    group_by(tipo_da_obra) %>% 
    summarise(quantidade = n()) %>% 
    ggplot(aes(x = reorder(tipo_da_obra, quantidade), y = quantidade)) +
        geom_bar(stat="identity") +
        labs(x = "tipo da obra") +
        coord_flip() +
        labs(title = "Disponibilidade dos tipos das obras")
```

Vemos que o tipo de obra mais presente nos dados é o tipo "outras", seguido de "pavimentação paralelepípedo" e "escola". Vemos que existem uma pequena quantidade de dados faltantes.

Vejamos se os dados disponíveis são mais recentes, ou o período é irrelevante:

```{r, echo=FALSE, warning=FALSE}
tipo.obra %>% 
    group_by(ano) %>% 
    summarise(
        total = n(),
        quantidade.dados.disponiveis = sum(!is.na(tipo_da_obra)),
        prop.dados.disponiveis = quantidade.dados.disponiveis / total
    ) %>% 
    ggplot(aes(x = ano, y = prop.dados.disponiveis)) +
        geom_line() +
        scale_y_continuous(labels = scales::percent) +
        labs(y = "proporção dos tipos das obras disponíveis",
             title = "Proporção dos tipos das obras disponíveis ao longo do tempo")
```

Vemos que a disponibilidade dos dados do tipo da obra cresceram ao longo do tempo, apesar de que, em todo período analisado, os tipos das obras tem uma boa disponibilidade de dados, se mantendo sempre acima de 98%.

### Análise temporal

Vejamos quais os tipos de obra que vem sendo mais construídos ao longo do tempo:

```{r, warning=FALSE}
obras.mais.construidas <- tipo.obra %>% 
    group_by(tipo_da_obra) %>% 
    summarise(quantidade = n()) %>% 
    arrange(-quantidade) %>% 
    head()

tipo.obra %>% 
    filter(ano > 1900, tipo_da_obra %in% obras.mais.construidas$tipo_da_obra) %>% 
    group_by(ano, tipo_da_obra) %>% 
    summarise(quantidade = n()) %>% 
    ggplot(aes(x = ano, y = quantidade, color = tipo_da_obra)) +
        geom_line() +
        labs(title = "Quantidades de obras agrupadas por tipo ao longo do tempo",
             subtitle = "Considerando obras depois de 1900")
```

Podemos ver que de 2002 à 2005 todas os tipos de obras tem uma tendência ascendente, além disso, dos seis tipos de construção mais construídos, a escolas e postos de saúdes são os únicos que tem uma tendência crescente até 2014, após isso todos tipos de obras tendem a cair. 

##Nome do jurisdicionado temporalmente

###Nome do jurisdicionado disponível

Vemos pelo gráfico abaixo que 100% das obras possuem o nome do jurisdicionado responsável.

```{r}


obra.jurisdicionado <- obra %>% 
    left_join(evolucao, by = c("id" = "fk_obra")) %>% 
    select(id, data_inicio_obra, valor_obra, descricao_sucinta_obra, fk_jurisdicionado) %>% 
    mutate(ano = lubridate::year(data_inicio_obra)) %>%
    left_join(jurisdicionado_db2, by = c("fk_jurisdicionado" = "id"))



obra.jurisdicionado %>%
    filter(ano > 1998) %>%
    group_by(ano) %>%
    summarise(
        total = n(),
        total_nao_vazio = sum(!is.na(nome))
      ) %>%
    ggplot(aes(x = ano, y = total_nao_vazio/total * 100)) + 
    geom_col() + 
    labs(title = "Jurisdicionado temporalmente", subtitle="Considerando obras a partir de 1998", y = "Porcentagem de obras que possuem nome do jurisdicionado", x= "Ano da obra")


```

### Quantidade de obras por jurisdicionado

No gráfico abaixo podemos ver quais jurisdicionados possuem a maior quantidade de obras (considerando obras de 1998 até os dias atuais). Algumas prefeituras de cidades tidas como pequenas aparecem no ranking enquanto orgãos de cidades maiores como Patos e Souza não aparecem.

```{r}

obra.jurisdicionado %>%
    filter(ano > 1998) %>%
    group_by(nome) %>%
    summarise(
        total = n()
      ) %>%
    top_n(10, total) %>%
    ggplot(aes(x = reorder(nome, -total), y = total)) + 
    geom_col() + 
    coord_flip() + 
    labs(x = "Jurisdicionado", y = "Quantidade de obras", title = "Top 10 jurisdicionados com maior quantidade de obras")

```
---
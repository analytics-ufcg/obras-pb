---
title: "Dados disponíveis por época"
output: 
    html_document:
        toc: true
        toc_float: true
        fig_width: 10
        fig_heigth: 8 
---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(RPostgreSQL)
library(knitr)
```


##Introdução

Os dados utilizados nessa análise são provenientes do banco de dados do TCE/PB, mais específicamente as bases de dados cabobranco e vigia, as quais são utilizadas na aplicação GEO Obras.

O intuito deste ralatório é verificar a disponibilidade dos dados temporalmente, visto que algumas colunas só se tornaram obrigatórias depois de algum tempo.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
drv <- DBI::dbDriver("PostgreSQL")

con1 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname1")
)

obra <- dbGetQuery(con1, "select * from t_obra")        
acompanhamento <- dbGetQuery(con1, "select * from t_acompanhamento")
complexo <- dbGetQuery(con1, "select * from t_complexo")
evolucao <- dbGetQuery(con1, "select * from t_evolucao")

con2 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname2")
)

jurisdicionado_db2 <- dbGetQuery(con2, "select * from t_jurisdicionado")
```

Utilizaremos a tabela de evolucao e utilizaremos a data de início da obra para fazera análise temporal.

```{r}
evolucao %>% 
    select(id, data_inicio_obra, data_prevista_conclusao, data_cadastro, fk_obra) %>% 
    head() %>% 
    kable()
```

Vejamos a existência dos dados georeferenciados temporalmente, onde a existência dos mesmos será indicada caso a geolocalização for do tipo 1 ou 3, visto que são os tipos cujos valores de geolocalização estão presentes na própria tabela, sendo um par de latitude e longitude, ou uma lista de pares. Não consideraremos os do tipo 2, que é uma referência para um arquivo .kml nem o tipo 0 que de fato é o valor inexistente.

```{r}
geolocalizacao <- acompanhamento %>% 
    group_by(fk_obra) %>% 
    summarise(
        tipo_georeferenciamento = ifelse(3 %in% tipo_georeferenciamento, 
                                             3,
                                             ifelse(1 %in% tipo_georeferenciamento, 
                                                    1,
                                                    ifelse(2 %in% tipo_georeferenciamento,
                                                           2,
                                                           0
                                                           )
                                                    )
                                             )
    ) %>% 
    left_join(evolucao, by = "fk_obra") %>% 
    select(fk_obra, tipo_georeferenciamento, data_inicio_obra) %>% 
    mutate(ano = lubridate::year(data_inicio_obra))

geolocalizacao.temporal <- geolocalizacao %>% 
    group_by(ano) %>% 
    summarise(
        total = n(),
        obras.geolocalizadas = sum(tipo_georeferenciamento == 1, tipo_georeferenciamento == 3),
        porcentagem.localizacao.disponivel = obras.geolocalizadas / total
        )

geolocalizacao.temporal %>%     
    filter(ano > 1900) %>% 
    ggplot(aes(x = ano, y = porcentagem.localizacao.disponivel)) +
    geom_line()
```

Analisando os dados de georeferenciamentos disponíveis, verificamos que existem alguns dados a partir de 2010, mas apenas no ano de 2017 existe um percentual razoável de dados geolocalizados, visto que chega a pouco mais de `r (geolocalizacao.temporal %>% select(porcentagem.localizacao.disponivel) %>% max() * 100) %>% format(digits=2, nsmall=2)`%.

Vejamos em números absoutos:

```{r}
geolocalizacao.temporal %>%     
    filter(ano > 1900) %>% 
    ggplot(aes(x = ano, y = obras.geolocalizadas)) +
    geom_line()
```

Podemos perceber que o número absoluto de obras geolocalizadas começa a crescer moderadamente a partir de 2010, mas tem uma ascensão mais forte a partir de 2015, chegando em `r geolocalizacao.temporal %>% select(obras.geolocalizadas) %>% max()` obras em 2017.

No total, existem `r geolocalizacao.temporal %>% select(obras.geolocalizadas) %>% sum()` geolocalizadas.

---
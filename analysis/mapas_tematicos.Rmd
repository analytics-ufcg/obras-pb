---
title: "Mapas Temáticos"
output: 
    html_document:
        toc: true
        toc_float: true
        fig_width: 10
        fig_heigth: 8 
---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(RPostgreSQL)
library(knitr)
library(jsonlite)
library(leaflet)
library(rgdal)
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
drv <- DBI::dbDriver("PostgreSQL")

con1 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname1")
)

obra <- dbGetQuery(con1, "select * from t_obra")        
acompanhamento <- dbGetQuery(con1, "select * from t_acompanhamento")
complexo <- dbGetQuery(con1, "select * from t_complexo")
evolucao <- dbGetQuery(con1, "select * from t_evolucao")

con2 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname2")
)

jurisdicionado_db2 <- dbGetQuery(con2, "select * from t_jurisdicionado")
localidade <- dbGetQuery(con2, "select * from t_localidade")

tipos.das.obras <- read.csv("tipos_obra.csv")
```

Nesta análise vamos identificar possíveis mapas temáticos para incorporar futuramente ao GeoPB, utilizando dados georeferenciados de obras da Paraíba.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
obra.georef <- acompanhamento %>% 
    left_join(obra, by = c("fk_obra" = "id")) %>% 
    left_join(localidade, by = c("fk_localidade" = "id"))
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Associa para cada obra uma localização georeferenciada

## Coloca o centróide no lugar de uma dista de localizações 

obra.filtrada <- obra.georef %>% 
    filter(tipo_georeferenciamento != 0)

is.dentro.pb <- function(lat,lon) {
    lon.min <- -38.770132
    lat.min <- -8.316999
    lon.max <- -34.5
    lat.max <- -5.995412
    return(lon.min < lon && lon < lon.max && lat.min < lat && lat < lat.max)
}

coord_divide <- function(value, parameter) {
    return(
        ifelse(value < parameter, 
               coord_divide(value / 10, parameter),
               value)
    )
}

corrige.coords <- function(coord1, coord2){
    coord1 <- if_else(coord1 > 0, coord1 * -1, coord1)
    coord2 <- if_else(coord2 > 0, coord2 * -1, coord2)
    
    lat <- max(coord1, coord2)
    lon <- min(coord1, coord2)
    
    lat <- coord_divide(lat, -10)
    lon <- coord_divide(lon, -100)
    
    return(c(lat = lat, lon = lon))
}

format.geo <- function(mat) {
    mat.pb <- data.frame(mat) %>% 
        rowwise() %>% 
        mutate(
            lat = corrige.coords(X1, X2)["lat"],
            lon = corrige.coords(X1, X2)["lon"]
        ) %>% 
        rowwise() %>% 
        filter(is.dentro.pb(lat, lon))
    
    coord1 <- mean(mat.pb$X1)
    coord2 <- mean(mat.pb$X2)
    
    coords <- corrige.coords(coord1, coord2)
    
    lat <- coords[1]
    lon <- coords[2]
    
    paste(lat,lon, sep = ",")
}

centroide <- function(localizacao) {
    
    coords <- tryCatch( 
        {
            parsed.mat <- matrix(jsonlite::fromJSON(localizacao), ncol = 2)
            
            return(format.geo(parsed.mat))
        },
        error=function(cond) {
            tryCatch(
                {
                    lista.loc.format <- strsplit(localizacao, "\\],")[[1]]
                    lista.loc.format <- str_replace_all(lista.loc.format, "\\[|\\]", "")
                    lista.coord <- unlist(strsplit(lista.loc.format, ","))
                    lista.coord <- trimws(lista.coord, which = "both")
                    lista.coord.format <- lapply(lista.coord, function(d){
                        as.numeric(unlist(strsplit(d, " "))[1])
                        })
                    parsed.matrix <- matrix(unlist(lista.coord.format), ncol = 2, byrow = TRUE)
                    
                    return(format.geo(parsed.matrix))
                },
                error = function(cond) {
                    return(localizacao)
                }
            )
            return(localizacao)
        }
    )
    coords
}

obra.georef.corrigido <- obra.filtrada %>% 
    rowwise() %>% 
    mutate(
        valor_georeferenciamento = ifelse(tipo_georeferenciamento != 1 & tipo_georeferenciamento != 3, 
                                          valor_georeferenciamento, 
                                          centroide(valor_georeferenciamento))
    ) %>%
    filter(
        tipo_georeferenciamento != 2
    ) %>% 
    separate(
        valor_georeferenciamento, 
        c("lat", "lon"),
        sep = ",",
        remove = FALSE,
        convert = TRUE
    ) %>% 
    filter(
        is.dentro.pb(lat,lon)
    )


obra.georef.centroide.sumarizado <- 
    obra.georef.corrigido %>%
    group_by(fk_obra) %>%
    mutate(lat = mean(lat), lon = mean(lon)) %>%
    select(-valor_georeferenciamento)

obra.georef.centroide.sumarizado <- obra.georef.centroide.sumarizado[!duplicated(obra.georef.centroide.sumarizado$fk_obra),]
#write_csv(obra.georef.centroide.sumarizado, "obras_georef_centroide_sumarizadas.csv")
    

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
obras.2003 <- obra %>% 
    left_join(localidade, by = c("fk_localidade" = "id")) %>% 
    left_join(evolucao, by = c("id" = "fk_obra")) %>% 
    mutate(ano = lubridate::year(data_inicio_obra)) %>% 
    filter(
        ano >= 2003
    ) %>% 
    left_join(tipos.das.obras, by = c("fk_tipo_obra" = "id"))

mapa_paraiba <- readOGR("mapa_paraiba_ibge/Municipios.shp")

municipios <- data.frame(nome = mapa_paraiba$Nome_Munic, lat = coordinates(mapa_paraiba)[,2], lon = coordinates(mapa_paraiba)[,1])
obras.2003 <- obras.2003 %>% 
    left_join(
        municipios, by = c("nome.x" = "nome")
    ) %>% 
    left_join(obra.georef.centroide.sumarizado %>% select(id,lat,lon), by = "id") %>% 
    mutate(
        lat = ifelse(is.na(lat.y), lat.x, lat.y), 
        lon = ifelse(is.na(lon.y), lon.x, lon.y) 
    ) %>% select(
        -lat.x, -lat.y, -lon.x, -lon.y
    )
    


obras.filtradas.valor <- obras.2003 %>% 
    filter(valor_obra > 1000)

obras.filtradas.dimensao <- obras.2003 %>% 
    filter(dimensao > 0)

valor.obras.municipio <- obras.filtradas.valor %>% 
    group_by(nome.x) %>% 
    summarise(
        valor.mediano = median(valor_obra),
        qtde.obras = n()
    )
```

Vamos ver o mapa da Paraíba:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Municípios que mudaram de nome ou que estão com o nome errado
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[156] = "Quixaba"
levels_mapa[173] = "Joca Claudino"
levels_mapa[179] = "São Domingos de Pombal"
levels_mapa[200] = "São Vicente do Seridó"

levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

mapa_paraiba@data <- mapa_paraiba@data %>%
  left_join(valor.obras.municipio,
            by = c("Nome_Munic" = "nome.x"))
```



Vamos elencar as variáveis disponíveis para mostrar nos mapas:

* Localidade
    + Mesoregião
    + Microregião
    + Nome
    + Georeferencia
* Valor
* Dimensão
* Tipo da obra
    + Nome
    + Unidade de medida
* Obra incorporável ao patrimônio
* Cancelada
* Data:
    + Ano
    + Início da obra
    + Previsão de conclusão
* Andamento

Vejamos o valor mediano das obras nos municípios paraibanos:

```{r}
colors <- colorNumeric("viridis", domain = c(min(mapa_paraiba@data$valor.mediano, na.rm = T), max(mapa_paraiba@data$valor.mediano, na.rm = T)))

mapa_paraiba %>% 
    leaflet() %>% 
    addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
    addPolygons(opacity = 0.5, 
              weight = 1, 
              fillColor = colors(mapa_paraiba@data$valor.mediano),
              color = 'black', 
              label = mapa_paraiba@data$Nome_Munic,
              popup = paste('Município: ', mapa_paraiba@data$Nome_Munic, '</br>Custo mediano das obras: R$ ', mapa_paraiba@data$valor.mediano, '</br>Número de obras: ', mapa_paraiba@data$qtde.obras),
              fillOpacity = 1) %>%
    addLegend(position = "bottomright", pal = colors, values = mapa_paraiba@data$valor.mediano,
            title = "Valor mediano das obras",
            opacity = 1)
```

Vejamos as obras de João Pessoa, Santa Rita e Pocinhos:

```{r}
obras.2003 %>% 
    filter(nome.x %in% c("João Pessoa", "Santa Rita", "Pocinhos")) %>% 
    arrange(-valor_obra) %>% 
    select(descricao_sucinta_obra, nome.x, valor_obra) %>% 
    top_n(10) %>% 
    kable()
```



---
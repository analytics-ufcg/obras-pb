---
title: "Inconsistência Geo-PB"
date: "November 20, 2017"
output: html_document
---

```{r, message=FALSE, warning=FALSE}
library(knitr)
library(kableExtra)
library(tidyverse)
library(RPostgreSQL)
library(config)
#devtools::install_github("sicarul/xray")
library(xray)
```

Criando conexão:

```{r}
drv <- DBI::dbDriver("PostgreSQL")

con1 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname1")
)

con2 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname2")
)

```

Importando dados:

```{r}
acompanhamento <- dbGetQuery(con1, "select * from t_acompanhamento")
complexo <- dbGetQuery(con1, "select * from t_complexo")       
convenio <- dbGetQuery(con1, "select * from t_convenio")         
empenhos_medicao <- dbGetQuery(con1, "select * from t_empenhos_medicao")
endereco <- dbGetQuery(con1, "select * from t_endereco")    
ente <- dbGetQuery(con1, "select * from t_ente")         
evolucao <- dbGetQuery(con1, "select * from t_evolucao")
foto_acompanhamento <- dbGetQuery(con1, "select * from t_foto_acompanhamento")
foto_medicao <- dbGetQuery(con1, "select * from t_foto_medicao")
jurisdicionado_db1 <- dbGetQuery(con1, "select * from t_jurisdicionado")     
medicao <- dbGetQuery(con1, "select * from t_medicao")   
municipio <- dbGetQuery(con1, "select * from t_municipio")          
obra <- dbGetQuery(con1, "select * from t_obra")        
origem <- dbGetQuery(con1, "select * from t_origem")             
parameter_db1 <- dbGetQuery(con1, "select * from t_parameter")
permission_db1 <- dbGetQuery(con1, "select * from t_permission")        
pessoa_db1 <- dbGetQuery(con1, "select * from t_pessoa")      
pessoafisica_db1 <- dbGetQuery(con1, "select * from t_pessoafisica")     
pessoajuridica_db1 <- dbGetQuery(con1, "select * from t_pessoajuridica")     
profile_db1 <- dbGetQuery(con1, "select * from t_profile")   
profile_permission_db1 <- dbGetQuery(con1, "select * from t_profile_permission")
recurso_proprio <- dbGetQuery(con1, "select * from t_recurso_proprio")
regularidade <- dbGetQuery(con1, "select * from t_regularidade")  
tipo_jurisdicionado_db1 <- dbGetQuery(con1, "select * from t_tipo_jurisdicionado")
user_db1 <- dbGetQuery(con1, "select * from t_user")
user_api_db1 <- dbGetQuery(con1, "select * from t_user_api")
user_profile_db1 <- dbGetQuery(con1, "select * from t_user_profile")

play_evolutions <- dbGetQuery(con2, "select * from play_evolutions")
contato <- dbGetQuery(con2, "select * from t_contato")
endereco <- dbGetQuery(con2, "select * from t_endereco")
gestao <- dbGetQuery(con2, "select * from t_gestao")
jurisdicionado_db2 <- dbGetQuery(con2, "select * from t_jurisdicionado")
localidade <- dbGetQuery(con2, "select * from t_localidade")
parameter_db2 <- dbGetQuery(con2, "select * from t_parameter")
periodoresponsabilidade <- dbGetQuery(con2, "select * from t_periodoresponsabilidade")
permission_db2 <- dbGetQuery(con2, "select * from t_permission")
pessoa_db2 <- dbGetQuery(con2, "select * from t_pessoa")
pessoafisica_db2 <- dbGetQuery(con2, "select * from t_pessoafisica")
pessoajuridica_db2 <- dbGetQuery(con2, "select * from t_pessoajuridica")
profile_db2 <- dbGetQuery(con2, "select * from t_profile")
profile_permission_db2 <- dbGetQuery(con2, "select * from t_profile_permission")
resto_a_pagar_temp <- dbGetQuery(con2, "select * from t_resto_a_pagar_temp")
tipo_jurisdicionado_db2 <- dbGetQuery(con2, "select * from t_tipo_jurisdicionado")
user_db2 <- dbGetQuery(con2, "select * from t_user")
user_api_db2 <- dbGetQuery(con2, "select * from t_user_api")
user_profile_db2 <- dbGetQuery(con2, "select * from t_user_profile")

```

Destas tabelas, apenas a de acompanhamento tem dados geo-referenciados, mas a principal tabela é a de obras, visto que estamos no escopo do GeoObras.

Vejamos a tabela de obras:

```{r}
obra %>% 
    str()
```

Vemos que existe uma foreign key para o jurisdicionado, mas a tabela de jurisdicionado do db1 é vazia.

```{r}
jurisdicionado_db1 %>% count()
```

Com isso, ela provavelmente se refere à tabela do db2, visto que existem observações no segundo.

```{r}
jurisdicionado_db2 %>% count()
```

A chave estrangeira fk_tipo_obra não é encontrada em nenhuma outra tabela, assim como fk_tipo_execucao. Apesar de existir uma coluna planilha_contratada na tabela obras, não foi encontrada outra tabela que seja referenciada por essa coluna.

Vejamos a tabela de localidade, referente a chave estrangeira de obras:

```{r}
localidade %>% 
    str()
```

Vemos que a tabela de localidades é referente à cidade, mas também contém informações de unidade federativa, mesoregião, microregião, etc.

Vejamos a tabela de jurisdicionados, referente à chave estrangeira de obras:

```{r}
jurisdicionado_db2 %>% 
    str()
```

Esta contém informações referentes ao jurisdicionado, onde o nome parece coincidir com a unidade gestora do banco de dados do SAGRES.

Vejamos a tabela de complexos, referente à chave estrangeira de obras:

```{r}
complexo %>% 
    str()
```

Podemos ver que a tabela de complexo complementa a de obra, visto que tem o tipo da obra. Além disso, cada complexo é referenciado por mais de uma obra, como podemos ver a seguir:

```{r}
obra %>% 
    filter(!is.na(fk_complexo_obras)) %>% 
    nrow()

complexo %>% 
    nrow()
```

Vemos que existe um complexo que é referenciado por 27920 obras.

```{r}
obra %>% 
    group_by(fk_complexo_obras) %>% 
    summarise(quantidade = n()) %>% 
    arrange(-quantidade) %>% 
    head() %>% 
    kable()

complexo %>% 
    filter(id == 298)
```

Vemos que o complexo é fictício, visto que a descrição é IMPORTAÇÃO GEOPB.

Vejamos a tabela de acompanhamento, a que de fato contém os pontos georeferenciados.

```{r}
acompanhamento %>% 
    str()

acompanhamento %>% 
    filter(tipo_georeferenciamento == 1) %>% 
    arrange(valor_georeferenciamento) %>% 
    head() %>% 
    kable()

acompanhamento %>% 
    filter(tipo_georeferenciamento == 2) %>% 
    head() %>% 
    kable()

acompanhamento %>% 
    filter(tipo_georeferenciamento == 3) %>% 
    head() %>% 
    kable()
```

Vemos que a geolocalização pode ser de três tipos, onde o 1 é uma lista de pares latitude e longitude, o tipo 2 é uma referência para um arquivo KML e o tipo 3 é apenas um par de latitude e longitude.

Vejamos os dados faltantes na tabela de obras:

```{r}
anomalies(obra) %>% 
    kable() %>% 
    scroll_box(width = "900px", height = "500px")
```

Vemos que exceto o numero do protocolo tramita que 0.05% das observações são nulas, nenhuma outra coluna tem observações nulas, porém a porcentagem de zeros chega a 97,36% em dimensão e 79,06% no valor da obra. Apesar de acusar 99,1% de zeros na coluna de obras canceladas, é uma coluna com tipo lógico, faz sentido que a maioria das obras não sejam canceladas, o que também acontece na coluna de obras incorporáveis ao patrimônio, onde acusa que 91,29% das obras tem valor zero.

Apesar da maioria das colunas não apresentarem valores nulos ou zeros, muitas delas possuem valores sem significado, por exemplo:

```{r}
obra %>% 
    group_by(numero_contrato) %>% 
    summarise(quantidade = n()) %>% 
    arrange(-quantidade) %>% 
    head() %>% 
    kable()
```

Existem 18567 números de contrato 0000, assim como 30 com valor "-".

Do mesmo modo, a coluna referente à descrição sucinta da obra tem alguns valores não nulos, mas sem significado:
```{r}
obras.sem.descricao <- obra %>% 
    filter(str_count(descricao_sucinta_obra, "[:alpha:]|[:blank:]") / nchar(descricao_sucinta_obra) < 0.6)

obras.sem.descricao %>% 
    head() %>% 
    kable()
```

```{r}
(obras.sem.descricao %>% count()) / (obra %>% count()) * 100
```


Onde existem 1.5% de dados com mais de 40% da palavra composta por caracteres diferente do alfabeto.

Da mesma forma, a descrição da localidade tem vários valores sem significados:

```{r}
obras.sem.localidade <- obra %>% 
    filter(str_count(descricao_localidade, "[:alpha:]|[:blank:]") / nchar(descricao_localidade) < 0.6)

obras.sem.localidade %>% 
    head() %>% 
    kable()

(obras.sem.localidade %>% count()) / (obra %>% count()) * 100
```

É possível ver que 1,58% das obras tem localidade composta por mais de 40% de caracteres diferente do alfabeto.

Vejamos os dados faltantes de jurisdicionados:

```{r}
anomalies(jurisdicionado_db2) %>% 
    kable() %>% 
    scroll_box(width = "900px", height = "500px")
```

Vemos que em 28,24% dos dados, o código do sagres é vazio e em 9,73% dos dados a esfera é nula.

Vejamos agora os dados das localidades:

```{r}
anomalies(localidade) %>% 
    kable() %>% 
    scroll_box(width = "900px", height = "500px")
```

Vemos que várias colunas da localidade tem 95,98% dos valores faltantes, como codigo_ibge, esfera, bandeira, brasao, link_ibge e link_wikipedia.

Agora pelo complexo:

```{r}
anomalies(complexo) %>% 
    kable() %>% 
    scroll_box(width = "900px", height = "500px")
```

Vemos que os dados de complexo parecem ser bem completos, não tendo dados faltantes, visto que a coluna cancelled é um boolean, onde nenhum complexo foi cancelado. Apesar disso, duas descrições não fazem sentido: 

```{r}
complexo %>% 
    filter(str_count(descricao, "[:alpha:]|[:blank:]") / nchar(descricao) < 0.6) %>% 
    kable()
```

Por último, vejamos os dados faltantes da tabela de acompanhamento:

```{r}
anomalies(acompanhamento) %>% 
    kable() %>% 
    scroll_box(width = "900px", height = "500px")
```

Vemos que tanto o tipo do georeferenciamento, quanto o valor do mesmo em 98,9% das linhas tem valor igual a zero.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
dbDisconnect(con1)
dbDisconnect(con2)
```

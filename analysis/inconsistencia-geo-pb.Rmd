---
title: "Inconsistência Geo-PB"
date: "November 20, 2017"
output: 
    html_document:
        fig_height: 10
        fig_width: 13
---

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(RPostgreSQL)
library(config)
library(plotly)
```

Criando conexão:

```{r}
drv <- DBI::dbDriver("PostgreSQL")

con1 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname1")
)

con2 <- DBI::dbConnect(drv, 
  host = config::get("host"),
  port = config::get("port"),
  user = config::get("user"),
  password = config::get("password"),
  dbname = config::get("dbname2")
)

```

Importando dados:

```{r}
acompanhamento <- dbGetQuery(con1, "select * from t_acompanhamento") 
complexo <- dbGetQuery(con1, "select * from t_complexo")       
convenio <- dbGetQuery(con1, "select * from t_convenio")         
empenhos_medicao <- dbGetQuery(con1, "select * from t_empenhos_medicao")
endereco <- dbGetQuery(con1, "select * from t_endereco")    
ente <- dbGetQuery(con1, "select * from t_ente")         
evolucao <- dbGetQuery(con1, "select * from t_evolucao")
foto_acompanhamento <- dbGetQuery(con1, "select * from t_foto_acompanhamento")
foto_medicao <- dbGetQuery(con1, "select * from t_foto_medicao")
jurisdicionado_db1 <- dbGetQuery(con1, "select * from t_jurisdicionado")     
medicao <- dbGetQuery(con1, "select * from t_medicao")   
municipio <- dbGetQuery(con1, "select * from t_municipio")          
obra <- dbGetQuery(con1, "select * from t_obra")        
origem <- dbGetQuery(con1, "select * from t_origem")             
parameter_db1 <- dbGetQuery(con1, "select * from t_parameter")
permission_db1 <- dbGetQuery(con1, "select * from t_permission")        
pessoa_db1 <- dbGetQuery(con1, "select * from t_pessoa")      
pessoafisica_db1 <- dbGetQuery(con1, "select * from t_pessoafisica")     
pessoajuridica_db1 <- dbGetQuery(con1, "select * from t_pessoajuridica")     
profile_db1 <- dbGetQuery(con1, "select * from t_profile")   
profile_permission_db1 <- dbGetQuery(con1, "select * from t_profile_permission")
recurso_proprio <- dbGetQuery(con1, "select * from t_recurso_proprio")
regularidade <- dbGetQuery(con1, "select * from t_regularidade")  
tipo_jurisdicionado_db1 <- dbGetQuery(con1, "select * from t_tipo_jurisdicionado")
user_db1 <- dbGetQuery(con1, "select * from t_user")
user_api_db1 <- dbGetQuery(con1, "select * from t_user_api")
user_profile_db1 <- dbGetQuery(con1, "select * from t_user_profile")

play_evolutions <- dbGetQuery(con2, "select * from play_evolutions")
contato <- dbGetQuery(con2, "select * from t_contato")
endereco <- dbGetQuery(con2, "select * from t_endereco")
gestao <- dbGetQuery(con2, "select * from t_gestao")
jurisdicionado_db2 <- dbGetQuery(con2, "select * from t_jurisdicionado")
localidade <- dbGetQuery(con2, "select * from t_localidade")
parameter_db2 <- dbGetQuery(con2, "select * from t_parameter")
periodoresponsabilidade <- dbGetQuery(con2, "select * from t_periodoresponsabilidade")
permission_db2 <- dbGetQuery(con2, "select * from t_permission")
pessoa_db2 <- dbGetQuery(con2, "select * from t_pessoa")
pessoafisica_db2 <- dbGetQuery(con2, "select * from t_pessoafisica")
pessoajuridica_db2 <- dbGetQuery(con2, "select * from t_pessoajuridica")
profile_db2 <- dbGetQuery(con2, "select * from t_profile")
profile_permission_db2 <- dbGetQuery(con2, "select * from t_profile_permission")
resto_a_pagar_temp <- dbGetQuery(con2, "select * from t_resto_a_pagar_temp")
tipo_jurisdicionado_db2 <- dbGetQuery(con2, "select * from t_tipo_jurisdicionado")
user_db2 <- dbGetQuery(con2, "select * from t_user")
user_api_db2 <- dbGetQuery(con2, "select * from t_user_api")
user_profile_db2 <- dbGetQuery(con2, "select * from t_user_profile")

```

Destas tabelas, apenas a de acompanhamento tem dados geo-referenciados, mas a principal tabela é a de obras, visto que estamos no escopo do GeoPB.

Vejamos a tabela de obras:

```{r}
obra %>% 
    str()
```

Vemos que existe uma foreign key para o jurisdicionado, mas a tabela de jurisdicionado do db1 é vazia.

```{r}
jurisdicionado_db1 %>% count()
```

Com isso, ela provavelmente se refere à tabela do db2, visto que existem observações no segundo.

```{r}
jurisdicionado_db2 %>% count()
```

A chave estrangeira fk_tipo_obra não é encontrada em nenhuma outra tabela, assim como fk_tipo_execucao.

Vejamos a tabela de localidade, referente a chave estrangeira de obras:

```{r}
localidade %>% 
    str()
```

Vemos que a tabela de localidades é referente à cidade, mas também contém informações de unidade federativa, mesoregião, microregião, etc.

Vejamos a tabela de jurisdicionados, referente à chave estrangeira de obras:

```{r}
jurisdicionado_db2 %>% 
    str()
```

Esta contém informações referentes ao jurisdicionado, onde o nome parece coincidir com a unidade gestora do banco de dados do SAGRES.

Vejamos a tabela de complexos, referente à chave estrangeira de obras:

```{r}
complexo %>% 
    str()
```

Podemos ver que a tabela de complexo complementa a de obra, visto que tem o tipo da obra.

Vejamos a tabela de acompanhamento, a que de fato contém os pontos georeferenciados.

```{r}
acompanhamento %>% 
    str()

acompanhamento %>% 
    filter(tipo_georeferenciamento == 1) %>% 
    head()

acompanhamento %>% 
    filter(tipo_georeferenciamento == 2) %>% 
    head()

acompanhamento %>% 
    filter(tipo_georeferenciamento == 3) %>% 
    head()
```

Vemos que a geolocalização pode ser de três tipos, onde o 1 é uma lista de pares latitude e longitude, o tipo 2 é uma referência para um arquivo KML e o tipo 3 é apenas um par de latitude e longitude.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
dbDisconnect(con1)
dbDisconnect(con2)
```



```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

######################################TRATANDO OS DADOS E JUNTANDO AS TABELAS######################################

UM_MILHAO = 1000000

jurisdicionado_db2_filtrado <- 
    jurisdicionado_db2 %>% 
    select(id, nome)


localidade_filtrado <-
    localidade %>% 
    select(mesoregiao, microregiao, nome, id) %>%
    mutate(municipio = nome) %>%
    select(-nome)

obra_filtrado <- 
    obra %>%
    select(fk_jurisdicionado, fk_localidade, descricao_localidade, descricao_sucinta_obra, valor_obra)


join_obras_jurisdicionado <- 
    base::merge(x = obra_filtrado, y = jurisdicionado_db2_filtrado, by.x = "fk_jurisdicionado", by.y = "id") %>%
    select(-fk_jurisdicionado)

join_obras_jurisdicionado <-
    base::merge(join_obras_jurisdicionado, localidade_filtrado, by.x="fk_localidade", by.y="id") %>%
    select(-fk_localidade)

######################################CRIANDO OS DATASETS QUE SERÃO PLOTADOS######################################

obras_por_mesoregiao <-
    join_obras_jurisdicionado %>% 
    group_by(mesoregiao) %>% 
    summarize(total_obras = sum(valor_obra))


obras_por_microregiao <-
    join_obras_jurisdicionado %>% 
    group_by(microregiao) %>% 
    summarize(total_obras = sum(valor_obra))

obras_por_municipio_top20 <-
    join_obras_jurisdicionado %>% 
    group_by(municipio) %>% 
    summarize(total_obras = sum(valor_obra)) %>% 
    top_n(20)

obras_por_orgao_top20 <-
    join_obras_jurisdicionado %>% 
    group_by(nome) %>% 
    summarize(total_obras = sum(valor_obra)) %>% 
    top_n(20)

obras_por_orgao_quantidade_top20 <-
    plyr::count(join_obras_jurisdicionado, 'municipio') %>%
    top_n(20)

outliers_borborema <-
    join_obras_jurisdicionado %>%
    filter(mesoregiao == "Borborema" & log(valor_obra) > 16)

outliers_sertao <-
    join_obras_jurisdicionado %>%
    filter(mesoregiao == "Sertão Paraibano" & log(valor_obra) > 16)

outliers_mata <-
    join_obras_jurisdicionado %>%
    filter(mesoregiao == "Mata Paraibana" & log(valor_obra) > 17)

outliers_agreste <-
    join_obras_jurisdicionado %>%
    filter(mesoregiao == "Agreste Paraibano" & log(valor_obra) > 16)

outliers <- rbind(outliers_agreste, outliers_borborema, outliers_mata, outliers_sertao)

mediana_mesoregiao <-
    join_obras_jurisdicionado %>%
    filter(valor_obra > UM_MILHAO) %>%
    group_by(mesoregiao) %>%
    summarise(mediana = median(valor_obra))

mediana_microregiao <-
    join_obras_jurisdicionado %>%
    filter(valor_obra > UM_MILHAO) %>%
    group_by(microregiao) %>%
    summarise(mediana = median(valor_obra))


getMedianaMicro <- function(microregiao) {
    mediana <- mediana_microregiao$mediana[mediana_microregiao$microregiao == microregiao]
    return(format(mediana/UM_MILHAO, digits = 2))
}

getMedianaMeso <- function(mesoregiao) {
    mediana <- mediana_mesoregiao$mediana[mediana_mesoregiao$mesoregiao == mesoregiao]
    return(format(mediana/UM_MILHAO, digits = 2))
}

breakString <- function(s) {
    s <- trimws(s)
    return(gsub('(.{1,45})(\\s|$)', '\\1\n', s))
}

```


<h1>Obras com valores extremos</h1>

Faremos agora uma análise sobre as obras que possuem valores distoantes das demais. Para isso vamos visualizar alguns gráficos para tentar entender melhor onde podem estar esses valores extremos.<br>


```{r}
######################################PLOTANDO OS FRÁFICOS######################################

obras_por_mesoregiao %>%
    filter(total_obras != 0) %>%
    mutate(total_obras = total_obras/ UM_MILHAO) %>%
    ggplot(aes(x = reorder(mesoregiao, -total_obras), y = total_obras)) + 
    geom_col() + 
    labs(title = "Gastos com obras por mesorregião", x="Mesorregião", y = "Valor gasto (milhões de R$)")
```



```{r}
obras_por_microregiao %>%
    filter(total_obras != 0) %>%
    mutate(total_obras = total_obras/ UM_MILHAO) %>%
    ggplot(aes(x = reorder(microregiao, -total_obras), y = total_obras)) + 
    geom_col() + 
    labs(title = "Gastos com obras por microrregião", x="Microrregião", y = "Valor gasto (milhões de R$)") + 
    coord_flip()
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
obras_por_municipio_top20 %>%
    filter(total_obras != 0) %>%
    mutate(total_obras = total_obras/ UM_MILHAO) %>%
    ggplot(aes(x = reorder(municipio, -total_obras), y = total_obras)) + 
    geom_col() + 
    labs(title = "Top 20 dos municípios que mais gastam", x="Município", y = "Valor gasto (milhões de R$)") + 
    coord_flip()

```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
obras_por_orgao_top20 %>%
    filter(total_obras != 0) %>%
    mutate(total_obras = total_obras/ UM_MILHAO) %>%
    ggplot(aes(x = reorder(nome, -total_obras), y = total_obras)) + 
    geom_col() + 
    labs(title = "Top 20 dos orgãos públicos que mais gastam", x="Orgão", y = "Valor gasto (milhões de R$)") + 
    coord_flip()
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
obras_por_orgao_quantidade_top20 %>%
    ggplot(aes(x = reorder(municipio, -freq), y = freq)) + 
    geom_col() + 
    coord_flip() +
    labs(title = "Top 20 dos orgãos públicos com maior quantidade de obras", x="Orgão", y = "Número de obras")
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
plotly::plot_ly(
    join_obras_jurisdicionado %>% filter(valor_obra > UM_MILHAO) %>% group_by(mesoregiao),
    x = ~mesoregiao,
    y = ~log(valor_obra),
    color = ~mesoregiao,
    type = "box",
    boxpoints = "suspectedoutliers"
) %>%
    plotly::layout(title = "Obras com valores extremos (considerando apenas obras com valor maior que um milhão)", xaxis=list(title="Mesorregião"), yaxis=list(title="Valor da obra em escala logarítimica"))
```


Agora que temos noção de quais são as obras distoantes podemos separar estas e mostrá-las em um gráfico interativo. Veja o gráfico abaixo com mais informações sobre essas obras.


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
outliers_ggplot <- 
    outliers %>% 
    mutate(mediana_meso = lapply(mesoregiao, getMedianaMeso), mediana_micro = lapply(microregiao, getMedianaMicro)) %>%
    ggplot(aes(y = valor_obra/UM_MILHAO, x = municipio, color = mesoregiao, 
               text = paste0("<b>Orgão: </b>", nome,
                             "<br><b>Valor:</b> R$", format(valor_obra/UM_MILHAO, digits = 2), " milhões", 
                             "<br><b>Mediana da mesoregião: </b>R$", mediana_meso, " milhões",
                             "<br><b>Mediana da microrregião: </b>R$", mediana_micro, " milhões",
                             "<br><b>Local da obra: </b>", breakString(descricao_localidade), 
                             "<b>Descrição: </b>", breakString(descricao_sucinta_obra)))) + 
    geom_point(alpha = .7) + 
    coord_flip() +
    labs(title = "Obras com valores extremos", x="Município", y = "Valor da obra em milões de R$")
    

plotly::ggplotly(outliers_ggplot, tooltip=c("text"))

```






